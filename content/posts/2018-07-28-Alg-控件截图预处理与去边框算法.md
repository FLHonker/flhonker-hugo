---
title: "控件截图预处理与去边框算法"
date: 2018-07-28T20:30:04+08:00
draft: false
categories: "opencv"
tags: ["Algorithm","opencv"]
---

# 控件截图预处理与去边框算法

> 恕我在该系列博客中不能粘贴大量代码和截图，该项目为公司内部模块开发实际案例，我们主要谈论问题的解决思路和算法设计方法以及对计算机视觉的理解，不针对具体实现，也不涉及核心技术。就当是Frank的计算机视觉开发感悟，O(∩_∩)O哈哈~

## opencv闪亮登场
[![opencvicon][1]](https://opencv.org/)

由于本项目OCR模块完全使用tesseract的接口，它就像一个黑盒，输入图片，输出识别出的文本。tesseract-OCR的识别算法是封装好的，提供了不同语言的训练字库，也可以使用自己训练的字库。我们既然把OCR核心完全交给了tesseract，那么我们就无需再自行设计识别算法。

前两周，他们把精力都放在了对字库的训练上，使用几百个文本框和按钮的截图进行训练。然而，有多少智能，就有多少人工。由于带有背景和边框的控件截图对文本识别率影响较大，每次都要手工修改很多文本。即使经过了大量样本的训练，对识别率的提高并不明显。况且，中文字形复杂多样，在识别上本身就是个难题。我们的测试软件应用场景以账号和数字居多，因此，我们先搞数字的识别和训练，做好了之后再加入中文识别。

第三周，Frank加入团队～

以Frank的风格，这种项目，第一想到的肯定不是什么tesseract，什么训练字库，那一定是opencv呀！没办法，老大他们之前没想到用opencv，一些前期的图片处理都是用Java做的，不敢恭维。既然tesseract是老大钦定的，那我们能做的肯定是图像预处理方面的优化喽。——我也不知道，下意识地就感悟到了这个重点，O(∩_∩)O哈哈~

根据以前做图像识别的经验，在文字识别方面，肯定是“白纸黑字”最最容易被机器识别啦。那么，我们的控件截图绝大部分是浅黑色边框、灰色渐变背景、黑字，还有最外面截图带上的白边。我们要做的就是把背景、边框都去除，以消除对文字识别的干扰。在这里，大致思索一下，后面肯定不只这么简单，一定会遇到特殊情况需要更复杂的解决方案。是时候有请opencv了。
经过一番折腾，终于帮大家都搭建好了`IntelliJ IDEA + JDK1.8 + opencv3.4`的开发环境。不过这里要吐槽一下，opencv、的java接口属实垃圾，像是被阉割版，缺这少那。如果大家用opencv，建议使用C++或者python，不要用java这种二货。

## 图像预处理

对！这正是重点，这就是提高识别率的方法。其目标就是：去除干扰文字的外围因素，尽可能达到“白纸黑字”的效果，且字迹能够不失真。

第一步，肯定是灰度处理，二值化。这里而言，灰度图只是中间产品，对我们没有用，直接threshold二值化就好。先预估设置一个二值化阈值(120)，输出二值化图片，惊呆了！文本框截图的边框、灰色背景全都去除了，只剩下“白纸黑字”。难道。。。这就是终极解决方案？不存在的，这只是个典型图，有的图就不行了。还得老老实实继续处理。

经过反复测试不同二值化阈值，发现灰色背景都可以靠二值化去除，就是边框会有的保留，有的去除。一开始，他们还都认为边框不会影响识别率，因为只用仅二值化处理的图片世界效果已经比较好了。但是以Frank的经验和感觉来讲，不去边框，早晚出事。最终，发现边框的害处了。有的数字紧贴左侧或者右侧边框，就会把边框识别成“1”，有的下边框穿过数字，识别不准确。好了，啥也别说了，去边框！

去边框的算法，是我根据灵感发挥出来的，也是基于所识别的截图的共同特点：边框占据整张图的80%宽高。算法描述如下：

1. 二值化，阈值=140；
2. 获得图片宽高: width = src.cols(), height = src.rows();
3. 从图片高度的一半处开始分别向上向下扫描每一行像素；
4. 统计每一行中黑色像素点(0)的个数计算所占整行的比率，如果黑色点比率开始出现高于80%，则认为到达上下边框线处，记录上下高度坐标y_down, y_top;
5. 同理，再从图片宽度的一半处分别向左向右扫描每一列像素，统计每一列中黑色像素点所占比率，如果开始出现高于90%（这里为避免数字“1”的干扰，设高一点），则认为到达了左右边框线，记录左右坐标x_left, x_right;
6. 根据获得的四角坐标，可以使用Rect从原图取得中间文本区域，存入Mat矩阵，就可以用于后续处理和识别了。

这个算法，是不是很简单，也很高效？不用很复杂的计算，只是，可能缺少了一点通用性和灵活性，但是在此项目中可以解决问题。




[1]:https://opencv.org/assets/theme/logo.png
[2]: