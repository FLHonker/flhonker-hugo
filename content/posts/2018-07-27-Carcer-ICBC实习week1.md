---
layout:     post
title:      ICBC广州研发部实习第一周经历
subtitle:   OpenCV+OCR算法研究与应用
date:       2018-07-27
author:     Frank Liu
header-img: img/post-bg-1.jpg
catalog: true
tags:
    - carcer
    - opencv
---

# ICBC广州研发部实习第一周经历

<center>
<img src="https://res.cloudinary.com/flhonker/image/upload/v1532694651/githubio/icbc/mmexport1531036987079.jpg
" width="60%" height="60%" />
ICBC研发中心外景
</center>

<center>
<img src="https://res.cloudinary.com/flhonker/image/upload/v1532694650/githubio/icbc/mmexport1531037069481.jpg
" width="60%" height="60%" />
ICBC开发中心前台
</center>

## 广研实习生概况

2018年中国工商银行广州研发部一共来了61名实习生，其中大部分是广州本地大学生（中山大学、广工、暨南大学、华南师范等），其余的就是来自武汉、西安、厦门、长沙的大学生，其实研究生的数量比本科生要多，可能因为主要是以研究为主。ICBC的的实习生待遇还是很好的：为外地学生提供三室一厅的公寓，有空调、洗衣机、厨房等，拎包入住；每月550元的饮食补贴，一天100元实习工资，有意外保险。

<center>
<img src="https://res.cloudinary.com/flhonker/image/upload/v1532694648/githubio/icbc/mmexport1531053301343.jpg
" width="60%" height="60%" />
粤韵庭院篮球场
</center>

<center>
<img src="https://res.cloudinary.com/flhonker/image/upload/v1532694649/githubio/icbc/mmexport1531053294392.jpg
" width="50%" height="50%" />
卧室
</center>

<center>
<img src="https://res.cloudinary.com/flhonker/image/upload/v1532694649/githubio/icbc/mmexport1531053285786.jpg
" width="60%" height="60%" />
厨房
</center>

<center>
<img src="https://res.cloudinary.com/flhonker/image/upload/v1532694649/githubio/icbc/mmexport1531053291407.jpg
" width="60%" height="60%" />
客厅
</center>


ICBC研发部每天8:30上班打卡，17:30下班，没有加班，全凭自愿；中午从11:30到12:30分批去饭堂就餐，下午13:30上班。

<center>
<img src="https://res.cloudinary.com/flhonker/image/upload/v1532694654/githubio/icbc/IMG_20180723_122323.jpg
" width="60%" height="60%" />
餐食
</center>

正式员工一般都有自己的折叠床，中午在办公位就地睡一觉。我们外地实习生住在离公司只有步行10分钟路程的粤韵庭院公寓，非常近便，公寓附近就是天河公园，晚上可以去散步。

<center>
<img src="https://res.cloudinary.com/flhonker/image/upload/v1532694656/githubio/icbc/IMG_20180725_181138.jpg
" width="60%" height="60%" />
天河公园
</center>

广研中心一共有6个部：行政部、开发一部、开发二部、开发三部、开发四部和测试部，广研的实验室是研究生物识别方向，杭州、上海、北京、珠海开发中心都有实验室，分别研究不同方向。进入广研，最有感触的还是关于计算机的安全管理。所有员工包括实习生，配发个人工作电脑，win7专业版，必须严格按规范命名后入域，入域后只能访问内网资源，不能介入互联网，不能通过wifi或蓝牙与个人设备相连。内部人员统一使用“工行e通信”交流，类似于QQ，内部人员互相加好友无需同意；使用IBM notes作为内部邮件系统，可以接收外部邮件，但不能往外网发邮件；所有电脑必须安装TMS桌面管理，监控计算机安全；不允许私自安装任何未经许可的软件，只能安装共享网盘里有的软件；要想插入U盘等必须经过审批，未经审批的U盘插入只能读不能写，经过审批和格式化的U盘只能在内部计算机上互相使用；一旦计算机接入外部互联网就会被监测到被通报；等等。

<center>
<img src="https://res.cloudinary.com/flhonker/image/upload/v1532694649/githubio/icbc/mmexport1531270823951.jpg
" width="60%" height="60%" />
计算机命名规范
</center>
## OCR研究

我被分配到广研测试部，和其余三名研究生：思奥姐、灿标、黄琼，研究E2E自动化测试的OCR功能，就是对交互场景窗体控件中的文字和数字等进行识别，生成自动化脚本，方便测试人员进行GUI的测试。我们四个在丹的带领下，实现OCR（光学字符识别）并保证识别率在90%以上，耗时在100ms以内。我当时知道这个课题，第一想到的当然是opencv，我的最爱。但是前两周我还没来报到，思奥姐和灿标两人一直是在用tesseract和自己训练的字库来识别，识别率不高，很多细节识别有误，比如数字中的逗号和小数点。由于汉字结构复杂，字库有限，识别效果很差，丹指示：我们的控件中绝大部分文本框输入的是数字，先把数字识别率提高到90%以上。于是，我们开始着手只研究数字部分的识别。

<center>
<img src="https://res.cloudinary.com/flhonker/image/upload/v1532694656/githubio/icbc/IMG_20180727_113146.jpg
" width="60%" height="60%" />
OCR研究小分队
</center>

截图中数字部分的识别有以下特点：
* 都是文本框中的输入数字
* 文本框都是灰色背景、白色背景、浅黑色边框，部分是表格数据截图
* 长数字中间会有`,`和`.`分隔
* 不排除文本框前后有留白或空余

根据之前灿标写的Java-OCR程序的处理过程，对图像进行二值化、降噪后，调用tesseract进行识别，整个过程十分简单，但是做的还远远不够。一是使用Java处理图像效率低，效果差，处理之后的图片影响识别率的因素还是很多；二是我怀疑tesseract封装接口的识别算法是否足够优秀。

我相信opencv经过训练之后识别字符的能力，因为之前我使用最简单的KNN算法，对3000个手写体数字样本进行训练之后，再对2000个测试样本识别，识别率能达到92%以上。何况控件中的印刷体数字规整一些，肯定更容易识别。经过几十张各有特点的文本框截图输入到tesseract测试，我发现tesseract的识别算法是足够满足我们的识别率需求的，前提是对图片进行足够的预处理。没有处理好的图片，再优秀的识别算法识别率也不高。

我刚来的前两天，我们4个一股脑地着眼于训练字库来提高识别率，其实靠训练字库已经达到了一个瓶颈，我们没有解决的是图片预处理的效果。通过比较tesseract识别正确和识别错误的图片的特点，我发现文本框的灰色背景和边框是影响识别率的最大因素。要想去除背景和边框，最好的工具还是opencv。为此，我开始搜索有没有去除边框的算法，有没有识别矩形区域的算法，有没有识别和提取文字区域的算法。最后锁定提取文字区域的算法，查询了一番，找到两个案例，分别是python的和C++的，运行一下，发现存在的问题是它会把表格和控件边框的交叉处也识别为文字区域，想着没准可以先用Java重写一番再优化一下。然而C++版的是VS+opencv写的，和Linux各种不兼容，放弃。Python版的更恶心，没有数据类型，而且Java版opencv没有Python版功能强大，很多函数不支持，写到一半写不下去了。而且重写后还有很多后续工作要做，麻烦。。。

经过我们一番讨论，大家一致认为是背景和边框影响了识别率后，决定齐心协力着手使用opencv和我们自己设计的算法流程去背景和边框完成对图片的预处理，再调用tesseract-OCR接口。大致设计了一下：先二值化，再降噪，使用[边框检测和去除算法][10](请见我的另一篇文章专门介绍)将边框去除，这样就可以完成大部分典型截图的预处理，生成白底黑字的图片输入tesseract，其余蓝色背景白色字等的特殊图片再设计专门算法。perfect！！

在我们配置好opencv+eclipse环境后，我开始写图片预处理的算法。opencv二值化图片时，有一个重要的参数——阈值，它决定了图片中什么程度的颜色会置为白色，什么程度会变成黑色。我先取个100试试，结果大吃一惊。使用阈值为100二值化之后的图片，灰色背景、浅黑色边框全没了！这样就可以直接输入tesseract完美识别了岂不是？试验了我的30张截图，都可以识别，而且之前逗号和小数点混淆无法识别的问题也解决了。接下来就是将它整合到Java-OCR程序里了。

整合完成之后，将项目发给他们分别测试，思奥姐发现问题了：她的很多表格截图和像素低的截图在二值化之后数字会失真和发生截断，导致4会识别为-1, 6和8混淆。后来，再试着提高阈值，110的时候恰好可以去除边框，120就有一部分无法去除边框，而且识别率都很差。最后试验150，虽然很多边框没有去除，但是对于之前典型的灰色背景的文本框中的数字，都是可以识别的，即使有边框也不影响识别。剩余的问题就是，表格区域的截图，边框颜色和数字一样，无法去除，而且干扰识别；蓝色背景的数字二值化后识别率很低。那么，接下来要解决的就还是上面提到的去边框的问题，蓝色背景图片可以二值化后反转颜色变成白底黑字，但还是要去边框。

ok，问题解决了，[去边框的问题][10]请看下回分解，谢谢！

## 实习生活感悟

我们小组的丹老大，非常年轻，很亲切，经常把我们喊到楼上吃吃喝喝。每周五下午休息时间是小组活动时间，会有丰盛的下午茶。

<center>
<img src="https://res.cloudinary.com/flhonker/image/upload/v1532694655/githubio/icbc/IMG_20180727_154718.jpg
" width="60%" height="60%" />
下午茶
</center>

来到部门接手工作，感觉还是挺适应的，任务还能按时完成，而且工作比较自由，随时可以临时休息。专业知识能用到，但是更重要的是你在大学阶段通过学习知识锻炼的学习能力和创新能力。你学了20年的知识，肯定不够下辈子用20年的。一方面要不断学习新知识，紧跟时代潮流，尤其是IT行业，放弃学习等于自愿被时代抛弃；另一方面，输入的知识是有限的，但是个人智慧的发挥是无限的。工作中，不可能顺顺利利地把所学的知识都用上，难免会有忘记，也难免会有特殊问题特殊处理，必须要活学活用，能够适时根据工作需要快速地学习新知识将其运用。

经过一番辛勤研究和工作付出，你会收获很多经验、满足感，但是你要意识到内心的空虚。你会为自己创新地用有限的知识解决了复杂的问题而自豪，但是也会内心发虚。你会感觉自己被工作所需榨干，有一种被压榨的感觉。因为工作是工作，它不像是你在学校的学习和研究，那会很随性，学多学少无所谓。工作是要为公司、为社会创造价值的。工作就意味着付出劳动收获报酬，是一个利用所学知识创造价值的过程。工作中遇到难题，会让你感觉所学知识的匮乏，会让你越发担心只有输出没有输入会没有了资本。工作中的任务是做不完的，无数的任务在等着你去付出知识和劳动。对于IT行业，特别是软件开发，似乎没有什么永恒的章程和工作逻辑，每每都会爆出新问题，它永远不会是简单的重复性工作，总是让人感到不安。

总之，只有不断学习才是进步之道。

记住一句话，拥有再好的工作，也会怀念上学的时光。


[10]:
